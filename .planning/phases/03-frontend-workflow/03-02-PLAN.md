---
phase: 03-frontend-workflow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/MailDetailPage.jsx
  - frontend/src/layouts/MainLayout.jsx
  - frontend/src/services/mailService.js
autonomous: true
requirements:
  - WORKFLOW-06
  - WORKFLOW-07
  - FRONTEND-04
  - FRONTEND-05
  - FRONTEND-06

must_haves:
  truths:
    - "Mail detail page shows a PDF attachment section when attachment_metadata.has_attachment is true"
    - "View PDF button opens the PDF in a new browser tab using the blob + createObjectURL pattern (not window.open with the raw URL)"
    - "Download PDF button triggers a file download using the same blob with a named anchor"
    - "Attachment section is hidden when has_attachment is false or attachment_metadata is absent"
    - "Role badge in top navigation displays 'auditor' and 'clerk' correctly (no fallback to raw string artifacts)"
    - "RemarksEditDialog is fully removed from MailDetailPage — no import, no state, no JSX"
  artifacts:
    - path: "frontend/src/pages/MailDetailPage.jsx"
      provides: "PDF attachment section with view/download buttons; RemarksEditDialog removed"
      contains: "attachment_metadata"
    - path: "frontend/src/services/mailService.js"
      provides: "viewPdf(id) method using Axios blob responseType"
      exports: ["viewPdf"]
    - path: "frontend/src/layouts/MainLayout.jsx"
      provides: "Role badge with human-readable labels for all 6 roles"
      contains: "auditor"
  key_links:
    - from: "MailDetailPage view button onClick"
      to: "mailService.viewPdf"
      via: "Axios blob response then URL.createObjectURL then window.open"
      pattern: "createObjectURL"
    - from: "mailService.viewPdf"
      to: "/api/records/{id}/pdf/view/"
      via: "api.get with responseType: 'blob'"
      pattern: "responseType.*blob"
---

<objective>
Add PDF attachment display to the mail detail page (view inline + download), remove the dead RemarksEditDialog, and update the role badge in the nav to show human-readable labels for all six roles.

Purpose: The backend exposes GET /records/{id}/pdf/view/ (JWT-protected, returns file via X-Accel-Redirect). window.open() cannot send auth headers, so the blob pattern is mandatory. attachment_metadata is already in the API response, so no extra API call is needed.
Output: MailDetailPage with a PDF section, mailService.viewPdf(), MainLayout with role label map.
</objective>

<execution_context>
@C:/Users/vaish/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vaish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/pages/MailDetailPage.jsx
@frontend/src/layouts/MainLayout.jsx
@frontend/src/services/mailService.js
@frontend/src/services/api.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add viewPdf service method and update role badge</name>
  <files>
    frontend/src/services/mailService.js
    frontend/src/layouts/MainLayout.jsx
  </files>
  <action>
In mailService.js, add viewPdf after uploadPdf (or after the existing methods if Plan 01 has not run yet — add it after createMail):

```js
/**
 * Fetch PDF as a Blob for inline viewing or download.
 * Uses Axios with responseType 'blob' to send the JWT Authorization header.
 * window.open() cannot be used directly because it does not send auth headers.
 * @param {string} id - Mail record ID
 * @returns {Promise<Blob>}
 */
async viewPdf(id) {
  const response = await api.get(`/records/${id}/pdf/view/`, {
    responseType: 'blob',
  });
  return response.data; // Blob
},
```

Note: if Plan 01 already added uploadPdf, add viewPdf immediately after it. If not, add it after createMail. Do not duplicate uploadPdf.

In MainLayout.jsx, add a role label map and use it for the role Chip. Replace the Chip at lines 69-73:

```jsx
{/* Role label map — covers all 6 roles */}
const ROLE_LABELS = {
  AG: 'AG',
  DAG: 'DAG',
  SrAO: 'Sr AO',
  AAO: 'AAO',
  auditor: 'Auditor',
  clerk: 'Clerk',
};
```

Add this constant OUTSIDE the component (above `const MainLayout = () => {`) so it is not recreated on every render.

Then replace the existing Chip line:
```jsx
<Chip
  label={user?.role || 'User'}
  size="small"
  color="secondary"
/>
```
with:
```jsx
<Chip
  label={ROLE_LABELS[user?.role] || user?.role || 'User'}
  size="small"
  color="secondary"
/>
```
  </action>
  <verify>
Grep 'viewPdf' in mailService.js — must exist.
Grep 'responseType' in mailService.js — must appear.
Grep 'ROLE_LABELS' in MainLayout.jsx — must exist.
Grep 'auditor' in MainLayout.jsx — must appear in ROLE_LABELS.
  </verify>
  <done>
mailService.viewPdf(id) exists, uses responseType: 'blob'. MainLayout has ROLE_LABELS constant covering all 6 roles and uses it in the Chip label.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PDF section to MailDetailPage and remove RemarksEditDialog</name>
  <files>
    frontend/src/pages/MailDetailPage.jsx
  </files>
  <action>
Make the following targeted changes to MailDetailPage.jsx:

REMOVE (dead code — no button ever calls setRemarksDialogOpen(true)):
- The import line: `import RemarksEditDialog from '../components/RemarksEditDialog';`
- The state: `const [remarksDialogOpen, setRemarksDialogOpen] = useState(false);`
- The handler: the entire `handleRemarksUpdate` function (lines 86-95)
- The JSX: `<RemarksEditDialog ... />` block (lines 564-570 approximately)

ADD to the MUI icons import: `PictureAsPdf as PdfIcon` (add alongside existing icons in the import block).

ADD a PDF attachment handler inside the component (before the `canEditRemarks` function):
```js
const handleViewPdf = async () => {
  try {
    const blob = await mailService.viewPdf(id);
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
    // Revoke after a short delay to allow the new tab to load
    setTimeout(() => URL.revokeObjectURL(url), 60000);
  } catch (err) {
    console.error('Failed to load PDF:', err);
  }
};

const handleDownloadPdf = async () => {
  try {
    const blob = await mailService.viewPdf(id);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = mail?.attachment_metadata?.original_filename || 'attachment.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 5000);
  } catch (err) {
    console.error('Failed to download PDF:', err);
  }
};
```

ADD a PDF attachment Paper section in the JSX. Place it AFTER the "Initial Instructions" Paper block (after the closing `}` of that conditional block) and BEFORE the "Action Buttons" Paper:

```jsx
{/* PDF Attachment */}
{mail?.attachment_metadata?.has_attachment && (
  <Paper sx={{ p: 3, mb: 3 }}>
    <Typography variant="h6" gutterBottom>
      PDF Attachment
    </Typography>
    <Divider sx={{ mb: 2 }} />
    <Box display="flex" alignItems="center" gap={2} flexWrap="wrap">
      <PdfIcon color="error" />
      <Box>
        <Typography variant="body2">
          {mail.attachment_metadata.original_filename || 'attachment.pdf'}
        </Typography>
        <Typography variant="caption" color="text.secondary">
          {mail.attachment_metadata.file_size_human || ''}{' '}
          {mail.attachment_metadata.uploaded_at
            ? `· Uploaded ${formatDateTime(mail.attachment_metadata.uploaded_at)}`
            : ''}
        </Typography>
      </Box>
      <Button
        variant="outlined"
        size="small"
        onClick={handleViewPdf}
      >
        View
      </Button>
      <Button
        variant="outlined"
        size="small"
        onClick={handleDownloadPdf}
      >
        Download
      </Button>
    </Box>
  </Paper>
)}
```

Also check if there is a `?pdfError=1` query param on load, and if so, show a warning. Add this near the top of the component after the state declarations:

```js
const [pdfUploadWarning, setPdfUploadWarning] = useState(false);

useEffect(() => {
  const params = new URLSearchParams(window.location.search);
  if (params.get('pdfError') === '1') {
    setPdfUploadWarning(true);
  }
}, []);
```

Add this Alert immediately after the "Back to Mail List" button (before the Header Paper):
```jsx
{pdfUploadWarning && (
  <Alert severity="warning" sx={{ mb: 2 }} onClose={() => setPdfUploadWarning(false)}>
    Mail was created successfully, but the PDF attachment could not be uploaded. You can retry uploading later if needed.
  </Alert>
)}
```
  </action>
  <verify>
Run: cd frontend && npm run build 2>&1 | tail -20
Must produce no errors.
Grep 'RemarksEditDialog' in MailDetailPage.jsx — must return nothing.
Grep 'handleRemarksUpdate' in MailDetailPage.jsx — must return nothing.
Grep 'attachment_metadata' in MailDetailPage.jsx — must appear.
Grep 'createObjectURL' in MailDetailPage.jsx — must appear.
  </verify>
  <done>
Build succeeds. MailDetailPage has no RemarksEditDialog import, state, handler, or JSX. PDF section is present and renders only when has_attachment is true. View and Download buttons use blob+createObjectURL pattern. pdfError=1 query param shows a dismissable warning Alert.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in frontend/ completes with exit code 0.
2. Grep 'RemarksEditDialog' in MailDetailPage.jsx returns no matches.
3. Grep 'createObjectURL' in MailDetailPage.jsx returns matches in both handleViewPdf and handleDownloadPdf.
4. Grep 'ROLE_LABELS' in MainLayout.jsx returns a match.
5. Grep 'attachment_metadata' in MailDetailPage.jsx returns matches in the PDF section JSX.
</verification>

<success_criteria>
- Mail detail page shows PDF section (filename, size, uploaded date) when attachment_metadata.has_attachment is true.
- View opens blob URL in new tab; Download triggers file download with original filename.
- RemarksEditDialog fully removed (no import, no state, no JSX).
- Role badge in nav shows 'Auditor' for role='auditor' and 'Clerk' for role='clerk'.
- npm run build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-frontend-workflow/03-02-SUMMARY.md`
</output>
