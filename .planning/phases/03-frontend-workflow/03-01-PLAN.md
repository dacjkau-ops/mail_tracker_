---
phase: 03-frontend-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/CreateMailPage.jsx
  - frontend/src/services/mailService.js
  - frontend/src/context/AuthContext.jsx
autonomous: true
requirements:
  - WORKFLOW-01
  - WORKFLOW-02
  - WORKFLOW-03
  - FRONTEND-01
  - FRONTEND-02
  - FRONTEND-03

must_haves:
  truths:
    - "User sees a free-text TextField for Action Required (not a Select/dropdown)"
    - "User sees a PDF upload input on the create mail form"
    - "File input shows selected filename and rejects non-PDF files and files over 10 MB"
    - "Submitting the form creates the mail record then uploads the PDF in a second request"
    - "If PDF upload fails after mail creation, user is redirected to detail page with a warning query param"
    - "auditor and clerk roles see the Create Mail button in the nav (canCreateMail returns true)"
  artifacts:
    - path: "frontend/src/pages/CreateMailPage.jsx"
      provides: "Create mail form with free-text action_required and PDF file input"
      contains: "uploadPdf"
    - path: "frontend/src/services/mailService.js"
      provides: "uploadPdf(id, file) method posting multipart/form-data to /records/{id}/pdf/"
      exports: ["uploadPdf"]
    - path: "frontend/src/context/AuthContext.jsx"
      provides: "canCreateMail returning true for all 6 roles"
      contains: "auditor"
  key_links:
    - from: "CreateMailPage.jsx onSubmit"
      to: "mailService.uploadPdf"
      via: "two-step: createMail then uploadPdf with created mail id"
      pattern: "uploadPdf.*createdMail"
    - from: "mailService.uploadPdf"
      to: "/api/records/{id}/pdf/"
      via: "FormData with file and upload_stage='created'"
      pattern: "FormData.*upload_stage"
---

<objective>
Update the create mail form to support free-text action_required and optional PDF upload via a two-step flow. Also expand canCreateMail() to allow all six roles.

Purpose: Backend now accepts free-text action_required and exposes POST /records/{id}/pdf/ for attachment upload. The frontend must be updated to match.
Output: CreateMailPage with TextField for action_required, a PDF file input, and two-step submit logic. mailService with uploadPdf(). canCreateMail() updated.
</objective>

<execution_context>
@C:/Users/vaish/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vaish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/pages/CreateMailPage.jsx
@frontend/src/services/mailService.js
@frontend/src/context/AuthContext.jsx
@frontend/src/services/api.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand canCreateMail and add uploadPdf service method</name>
  <files>
    frontend/src/context/AuthContext.jsx
    frontend/src/services/mailService.js
  </files>
  <action>
In AuthContext.jsx, update canCreateMail() at line 113-116:
- Change the return to: return ['AG', 'DAG', 'SrAO', 'AAO', 'auditor', 'clerk'].includes(user?.role);
- Remove the old comment that says "Only AG can create mails".

In mailService.js, add a new uploadPdf method after createMail (after line 40):

```js
/**
 * Upload PDF attachment to an existing mail record.
 * Must be called AFTER createMail() with the returned id.
 * @param {string} id - Mail record ID
 * @param {File} file - PDF File object
 * @returns {Promise}
 */
async uploadPdf(id, file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_stage', 'created');
  const response = await api.post(`/records/${id}/pdf/`, formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
  });
  return response.data;
},
```

The api instance already attaches Authorization header via its request interceptor, so no extra auth header is needed here.
  </action>
  <verify>
Search for 'auditor' in AuthContext.jsx — must appear in canCreateMail.
Search for 'uploadPdf' in mailService.js — must appear.
Search for 'upload_stage' in mailService.js — must appear.
  </verify>
  <done>
canCreateMail() returns true for 'auditor' and 'clerk'. mailService has uploadPdf(id, file) posting FormData with file and upload_stage='created' to /records/{id}/pdf/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite CreateMailPage — free-text action_required + PDF upload</name>
  <files>
    frontend/src/pages/CreateMailPage.jsx
  </files>
  <action>
Rewrite CreateMailPage.jsx with these specific changes (preserve all unchanged sections verbatim):

REMOVE from imports:
- `FormControl, InputLabel, Select, MenuItem` from MUI import (keep Box, Paper, Typography, TextField, Button, Alert, CircularProgress, Autocomplete, Chip)
- `ACTION_REQUIRED_OPTIONS` from '../utils/constants'

ADD to imports:
- `AttachFile as AttachFileIcon` from '@mui/icons-material'
- `LinearProgress` from '@mui/material'

REMOVE state:
- `const [showOtherAction, setShowOtherAction] = useState(false);`

REMOVE from useForm defaultValues:
- `action_required_other: '',`

REMOVE:
- `const actionRequired = watch('action_required');` (line 65)
- The entire useEffect watching actionRequired (lines 71-73)

ADD state (after the existing state declarations):
- `const [selectedPdf, setSelectedPdf] = useState(null);`
- `const [pdfError, setPdfError] = useState('');`

ADD file handler (before onSubmit):
```js
const handleFileChange = (e) => {
  const file = e.target.files[0];
  setPdfError('');
  if (!file) {
    setSelectedPdf(null);
    return;
  }
  if (file.type !== 'application/pdf') {
    setPdfError('Only PDF files are accepted.');
    setSelectedPdf(null);
    e.target.value = '';
    return;
  }
  const maxBytes = 10 * 1024 * 1024; // 10 MB
  if (file.size > maxBytes) {
    setPdfError('PDF must be 10 MB or smaller.');
    setSelectedPdf(null);
    e.target.value = '';
    return;
  }
  setSelectedPdf(file);
};
```

UPDATE onSubmit:
- Remove the `action_required === 'Other' ? data.action_required_other : data.action_required` sentinel logic.
- Change to: `action_required: data.action_required,`
- After `const createdMail = await mailService.createMail(mailData);`, add:
```js
if (selectedPdf) {
  try {
    await mailService.uploadPdf(createdMail.id, selectedPdf);
  } catch (pdfErr) {
    navigate(`/mails/${createdMail.id}?pdfError=1`);
    return;
  }
}
navigate(`/mails/${createdMail.id}`);
```
- Remove the existing `navigate(`/mails/${createdMail.id}`);` line that was there before (since we now navigate inside the if/else).

REPLACE the action_required FormControl/Select block (the entire Box at lines 241-265) with:
```jsx
<Box sx={{ flex: '1 1 300px', minWidth: '250px' }}>
  <Controller
    name="action_required"
    control={control}
    rules={{ required: 'Action Required is required' }}
    render={({ field }) => (
      <TextField
        {...field}
        fullWidth
        label="Action Required *"
        placeholder="e.g. Review, Approve, Process..."
        error={!!errors.action_required}
        helperText={errors.action_required?.message}
      />
    )}
  />
</Box>
```

REMOVE the entire conditional "Specify Other Action" JSX block (lines 267-289).

ADD a PDF upload section after the "Initial Instructions" Row (after the closing Box of Row 7, before the Action Buttons Box):
```jsx
{/* PDF Attachment (Optional) */}
<Box>
  <Typography variant="subtitle2" color="text.secondary" sx={{ mb: 1 }}>
    PDF Attachment (Optional)
  </Typography>
  <Button
    component="label"
    variant="outlined"
    startIcon={<AttachFileIcon />}
    size="small"
  >
    {selectedPdf ? selectedPdf.name : 'Choose PDF'}
    <input
      type="file"
      accept="application/pdf"
      hidden
      onChange={handleFileChange}
    />
  </Button>
  {selectedPdf && (
    <Typography variant="caption" color="text.secondary" sx={{ ml: 2 }}>
      {(selectedPdf.size / 1024 / 1024).toFixed(2)} MB selected
    </Typography>
  )}
  {pdfError && (
    <Typography variant="caption" color="error" display="block" sx={{ mt: 0.5 }}>
      {pdfError}
    </Typography>
  )}
</Box>
```

REMOVE watch import usage — if `watch` is no longer used anywhere after removing the action_required watch, remove `watch,` from the useForm destructure.

The `setValue` import can also be removed from useForm if it is not used elsewhere in the file. Check — it is not used. Remove it.

After cleanup, the useForm destructure should be:
```js
const { control, handleSubmit, formState: { errors } } = useForm({ defaultValues: { ... } });
```
  </action>
  <verify>
Run: cd frontend && npm run build 2>&1 | tail -20
Must produce no errors.
  </verify>
  <done>
Build succeeds with no errors. CreateMailPage has TextField for action_required, no Select/FormControl for that field, no showOtherAction state, no conditional "Specify Action" block. File input accepts PDF only, validates size, shows filename. onSubmit calls uploadPdf after createMail and navigates to ?pdfError=1 on PDF failure.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in frontend/ completes with exit code 0 and no errors.
2. Grep for 'ACTION_REQUIRED_OPTIONS' in CreateMailPage.jsx — must return nothing.
3. Grep for 'showOtherAction' in CreateMailPage.jsx — must return nothing.
4. Grep for 'auditor' in AuthContext.jsx — must appear in canCreateMail array.
5. Grep for 'uploadPdf' in mailService.js — must appear.
6. Grep for 'upload_stage' in mailService.js — must appear.
</verification>

<success_criteria>
- canCreateMail() returns true for auditor and clerk.
- mailService.uploadPdf(id, file) exists and posts multipart/form-data with upload_stage='created'.
- CreateMailPage uses TextField (not Select) for action_required.
- CreateMailPage has a PDF file input with client-side PDF type and 10 MB size validation.
- Two-step submit: createMail then uploadPdf; PDF failure redirects to ?pdfError=1 rather than blocking navigation.
- npm run build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/03-frontend-workflow/03-01-SUMMARY.md`
</output>
