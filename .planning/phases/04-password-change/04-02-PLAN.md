---
phase: 04-password-change
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - frontend/src/services/authService.js
  - frontend/src/pages/ChangePasswordPage.jsx
  - frontend/src/pages/LoginPage.jsx
  - frontend/src/App.jsx
autonomous: false
requirements:
  - PASSWD-01
  - PASSWD-02
  - PASSWD-06
  - PASSWD-07

must_haves:
  truths:
    - "Login page shows a 'Change Password' link that navigates to /change-password"
    - "/change-password page renders a form with Username, Current Password, New Password, and Confirm New Password fields"
    - "Submitting valid credentials and a matching 8+ character new password redirects to /login with a visible success message"
    - "Submitting wrong current password shows 'Current password is incorrect.' error on the form"
    - "Submitting mismatched passwords shows 'New passwords do not match.' error on the form"
    - "Submitting a password shorter than 8 characters shows 'New password must be at least 8 characters.' error on the form"
    - "/change-password is accessible to unauthenticated users (not behind ProtectedRoute)"
  artifacts:
    - path: "frontend/src/pages/ChangePasswordPage.jsx"
      provides: "Change password form page component"
      contains: "ChangePasswordPage"
    - path: "frontend/src/services/authService.js"
      provides: "changePassword API call function"
      contains: "changePassword"
    - path: "frontend/src/pages/LoginPage.jsx"
      provides: "Change Password link below the sign-in form"
      contains: "change-password"
    - path: "frontend/src/App.jsx"
      provides: "Route registration for /change-password"
      contains: "/change-password"
  key_links:
    - from: "frontend/src/pages/ChangePasswordPage.jsx"
      to: "frontend/src/services/authService.js"
      via: "authService.changePassword()"
      pattern: "authService\\.changePassword|changePassword"
    - from: "frontend/src/services/authService.js"
      to: "/api/auth/change-password/"
      via: "api.post('/auth/change-password/', ...)"
      pattern: "auth/change-password"
    - from: "frontend/src/App.jsx"
      to: "frontend/src/pages/ChangePasswordPage.jsx"
      via: "<Route path='/change-password' element={<ChangePasswordPage />}>"
      pattern: "change-password.*ChangePasswordPage"
---

<objective>
Add the frontend change-password feature: a new page at /change-password with a four-field form, a link to it from the login page, and an API service function that calls the backend endpoint.

Purpose: Gives users a self-service way to update their password directly from the login screen, with clear field-level error messages and a redirect-with-success-message flow on completion.
Output: ChangePasswordPage.jsx, changePassword() in authService.js, link in LoginPage.jsx, route in App.jsx.
</objective>

<execution_context>
@C:/Users/vaish/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vaish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-password-change/04-01-SUMMARY.md
@frontend/src/pages/LoginPage.jsx
@frontend/src/services/authService.js
@frontend/src/services/api.js
@frontend/src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add changePassword to authService and create ChangePasswordPage</name>
  <files>
    frontend/src/services/authService.js
    frontend/src/pages/ChangePasswordPage.jsx
  </files>
  <action>
**1. Add `changePassword` to `frontend/src/services/authService.js`**

Add the following method to the `authService` object, after the existing `refreshToken` method and before the closing `};`:

```javascript
  /**
   * Change user password (no JWT required — authenticates via username + current password)
   * @param {string} username
   * @param {string} currentPassword
   * @param {string} newPassword
   * @param {string} confirmPassword
   * @returns {Promise<{message: string}>}
   */
  async changePassword(username, currentPassword, newPassword, confirmPassword) {
    const response = await api.post('/auth/change-password/', {
      username,
      current_password: currentPassword,
      new_password: newPassword,
      confirm_password: confirmPassword,
    });
    return response.data;
  },
```

**2. Create `frontend/src/pages/ChangePasswordPage.jsx`**

Create a new file. Pattern this page after `LoginPage.jsx` — same Card/Container wrapper, same MUI imports, same hook patterns. The page must:

- Use `useNavigate` from `react-router-dom`
- Use `useLocation` from `react-router-dom` to read `location.state?.successMessage` (so the login page can pass a message, but this page does not need it — it sends a message TO login)
- Have four controlled TextField inputs: username, current_password, new_password, confirm_password (all type="password" except username)
- Have a single `error` string state for the API error message
- Have a `loading` boolean state
- On submit: call `authService.changePassword(...)`, on success navigate to `/login` with `state: { successMessage: 'Password changed successfully. Please log in with your new password.' }`, on failure display `error.response?.data?.error` or a fallback message
- Show a "Back to Login" link (MUI `Link` or plain `<a>`) that navigates to `/login`

Full component:

```jsx
import React, { useState } from 'react';
import { useNavigate, Link as RouterLink } from 'react-router-dom';
import {
  Box,
  Card,
  CardContent,
  TextField,
  Button,
  Typography,
  Alert,
  Container,
  CircularProgress,
  Link,
} from '@mui/material';
import authService from '../services/authService';

const ChangePasswordPage = () => {
  const navigate = useNavigate();

  const [formData, setFormData] = useState({
    username: '',
    current_password: '',
    new_password: '',
    confirm_password: '',
  });
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleChange = (e) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
    setError('');
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      await authService.changePassword(
        formData.username,
        formData.current_password,
        formData.new_password,
        formData.confirm_password
      );
      navigate('/login', {
        state: {
          successMessage: 'Password changed successfully. Please log in with your new password.',
        },
      });
    } catch (err) {
      const message =
        err.response?.data?.error ||
        'Failed to change password. Please try again.';
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Container maxWidth="sm">
      <Box
        sx={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
        }}
      >
        <Card sx={{ width: '100%', maxWidth: 500 }}>
          <CardContent sx={{ p: 4 }}>
            <Typography variant="h4" component="h1" gutterBottom align="center" sx={{ mb: 3 }}>
              Change Password
            </Typography>

            <Typography variant="body1" align="center" color="text.secondary" sx={{ mb: 4 }}>
              Enter your username and current password to set a new password.
            </Typography>

            {error && (
              <Alert severity="error" sx={{ mb: 3 }}>
                {error}
              </Alert>
            )}

            <form onSubmit={handleSubmit}>
              <TextField
                fullWidth
                label="Username"
                name="username"
                value={formData.username}
                onChange={handleChange}
                margin="normal"
                required
                autoFocus
                disabled={loading}
              />

              <TextField
                fullWidth
                label="Current Password"
                name="current_password"
                type="password"
                value={formData.current_password}
                onChange={handleChange}
                margin="normal"
                required
                disabled={loading}
              />

              <TextField
                fullWidth
                label="New Password"
                name="new_password"
                type="password"
                value={formData.new_password}
                onChange={handleChange}
                margin="normal"
                required
                disabled={loading}
                helperText="Minimum 8 characters"
              />

              <TextField
                fullWidth
                label="Confirm New Password"
                name="confirm_password"
                type="password"
                value={formData.confirm_password}
                onChange={handleChange}
                margin="normal"
                required
                disabled={loading}
              />

              <Button
                type="submit"
                fullWidth
                variant="contained"
                size="large"
                sx={{ mt: 3 }}
                disabled={loading}
              >
                {loading ? <CircularProgress size={24} /> : 'Change Password'}
              </Button>
            </form>

            <Box sx={{ mt: 3, textAlign: 'center' }}>
              <Link component={RouterLink} to="/login" variant="body2">
                Back to Login
              </Link>
            </Box>
          </CardContent>
        </Card>
      </Box>
    </Container>
  );
};

export default ChangePasswordPage;
```
  </action>
  <verify>
Check the files exist and contain the expected identifiers:
```bash
grep -n "changePassword" frontend/src/services/authService.js
grep -n "ChangePasswordPage\|change-password\|navigate.*login" frontend/src/pages/ChangePasswordPage.jsx
```
Expect both greps to return matches.
  </verify>
  <done>authService.changePassword() calls POST /auth/change-password/ with {username, current_password, new_password, confirm_password}. ChangePasswordPage.jsx renders four fields, displays API error messages in an Alert, and navigates to /login with a successMessage state on success.</done>
</task>

<task type="auto">
  <name>Task 2: Add Change Password link to LoginPage and register route in App.jsx</name>
  <files>
    frontend/src/pages/LoginPage.jsx
    frontend/src/App.jsx
  </files>
  <action>
**1. Update `frontend/src/pages/LoginPage.jsx`**

Add two things:

a. Add new imports at the top (after the existing `import { useAuth }` line):
```jsx
import { Link as RouterLink, useLocation } from 'react-router-dom';
import Link from '@mui/material/Link';
```
Note: MUI components like `Box`, `Card`, `Typography` etc. are already imported via the existing MUI import block. Add `Link` to that block, or import it separately. Add `Link as RouterLink` and `useLocation` to the react-router-dom import.

b. Inside the `LoginPage` component, add `useLocation` call to read success message:
```jsx
const location = useLocation();
const successMessage = location.state?.successMessage || '';
```

c. Add success Alert display below the existing `{error && ...}` Alert (and above the `<form>`):
```jsx
{successMessage && (
  <Alert severity="success" sx={{ mb: 3 }}>
    {successMessage}
  </Alert>
)}
```

d. Add a "Change Password" link below the submit Button (inside `<form>`, after the Button, or just after the `</form>` closing tag):
```jsx
<Box sx={{ mt: 3, textAlign: 'center' }}>
  <Link component={RouterLink} to="/change-password" variant="body2">
    Change Password
  </Link>
</Box>
```

**2. Update `frontend/src/App.jsx`**

a. Add the import for `ChangePasswordPage` alongside the other page imports:
```jsx
import ChangePasswordPage from './pages/ChangePasswordPage';
```

b. Add a new route inside `<Routes>` for `/change-password`. This route must NOT be inside the `ProtectedRoute` wrapper — it must be accessible to unauthenticated users. Add it as a sibling to the `/login` route:
```jsx
<Route
  path="/change-password"
  element={<ChangePasswordPage />}
/>
```

The final Routes structure should look like:
```jsx
<Routes>
  <Route path="/login" element={<PublicRoute><LoginPage /></PublicRoute>} />
  <Route path="/change-password" element={<ChangePasswordPage />} />
  <Route path="/" element={<ProtectedRoute><MainLayout /></ProtectedRoute>}>
    <Route index element={<Navigate to="/mails" replace />} />
    <Route path="mails" element={<MailListPage />} />
    <Route path="mails/create" element={<CreateMailPage />} />
    <Route path="mails/:id" element={<MailDetailPage />} />
  </Route>
  <Route path="*" element={<Navigate to="/mails" replace />} />
</Routes>
```

Note: Do NOT wrap /change-password in PublicRoute (which redirects authenticated users). An authenticated user who wants to change their password should still be able to access this page.
  </action>
  <verify>
```bash
grep -n "change-password\|ChangePasswordPage\|successMessage" frontend/src/pages/LoginPage.jsx
grep -n "change-password\|ChangePasswordPage" frontend/src/App.jsx
```
Expect all four identifiers to appear.

Start the frontend dev server and verify:
- Navigate to http://localhost:5173/login — "Change Password" link appears below the Sign In button
- Click the link — browser navigates to /change-password
- The /change-password page renders with all four fields
  </verify>
  <done>LoginPage.jsx shows "Change Password" link that navigates to /change-password. LoginPage.jsx displays a green success Alert when location.state.successMessage is set. App.jsx registers /change-password as a public route rendering ChangePasswordPage.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify the complete password-change flow end-to-end</name>
  <what-built>
Complete password-change flow: backend endpoint (plan 04-01) + frontend page + login link + success redirect (plan 04-02).
  </what-built>
  <how-to-verify>
Start both backend and frontend dev servers, then:

1. **Verify "Change Password" link is visible on the login page**
   - Visit http://localhost:5173/login
   - Confirm a "Change Password" link appears below the Sign In button
   - Click it — confirm navigation to /change-password

2. **Test wrong current password error**
   - On /change-password, fill: Username=admin, Current Password=wrongpassword, New Password=MyNewPass1, Confirm New Password=MyNewPass1
   - Click "Change Password"
   - Confirm the red Alert shows: "Current password is incorrect."

3. **Test mismatched passwords error**
   - Fill: Username=admin, Current Password=correct, New Password=MyNewPass1, Confirm New Password=DifferentPass2
   - Confirm the red Alert shows: "New passwords do not match."

4. **Test too-short password error**
   - Fill: Username=admin, Current Password=correct, New Password=abc, Confirm New Password=abc
   - Confirm the red Alert shows: "New password must be at least 8 characters."

5. **Test successful password change (use a real test account, not admin)**
   - Create or use a known user (e.g., a test SrAO account)
   - Fill the form with correct credentials and a valid new password
   - Confirm: browser redirects to /login, green success Alert shows "Password changed successfully. Please log in with your new password."
   - Log in with the new password — confirm it works
   - Log in with the old password — confirm it fails

6. **Test "Back to Login" link**
   - On /change-password, click "Back to Login"
   - Confirm navigation back to /login
  </how-to-verify>
  <action>Human verification step — no code changes. Follow the how-to-verify steps above using both dev servers.</action>
  <verify>All 6 verification checks pass as described above.</verify>
  <done>Human has confirmed the complete password-change flow works end-to-end: link visible on login page, all error messages display correctly, successful change redirects to /login with success message, old password is rejected after change.</done>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Run the frontend build to ensure no import errors or missing files:
```bash
cd frontend && npm run build
```
Expect: build completes without errors. If warnings appear about unused variables, fix them before marking complete.
</verification>

<success_criteria>
- /change-password page accessible at http://localhost:5173/change-password without being logged in
- Login page shows "Change Password" link
- All four error conditions produce distinct, specific error messages from the API
- Successful change redirects to /login with success message visible
- Old password no longer works after a successful change
- npm run build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-password-change/04-02-SUMMARY.md` documenting:
- Files created/modified
- The full frontend flow (link -> form -> API call -> redirect)
- Any MUI component choices made
- Verification results
</output>
