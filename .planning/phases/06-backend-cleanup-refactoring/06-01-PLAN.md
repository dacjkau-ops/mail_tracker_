---
phase: 06-backend-cleanup-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/records/models.py
  - backend/records/serializers.py
  - backend/records/admin.py
  - backend/records/views.py
  - frontend/src/utils/dateHelpers.js
autonomous: true
requirements:
  - CLEAN-01
  - CLEAN-02
  - CLEAN-03
  - CLEAN-04
  - CLEAN-05
must_haves:
  truths:
    - "MailRecord model has no action_required_other or remarks field"
    - "MailAssignment model has no user_remarks field"
    - "Django migration removes the three fields cleanly"
    - "No import of formatDistanceToNow or definition of getRelativeTime in frontend"
    - "All existing serializers, admin, and views compile without referencing removed fields"
  artifacts:
    - path: "backend/records/models.py"
      provides: "Clean MailRecord and MailAssignment without deprecated fields"
      contains: "class MailRecord"
    - path: "backend/records/serializers.py"
      provides: "Serializers without action_required_other, remarks, user_remarks references"
      contains: "class MailRecordCreateSerializer"
    - path: "backend/records/admin.py"
      provides: "Admin config without deprecated field references"
      contains: "class MailRecordAdmin"
    - path: "frontend/src/utils/dateHelpers.js"
      provides: "Date helpers without getRelativeTime or formatDistanceToNow"
      exports: ["calculateTimeInStage", "isOverdue", "formatDate", "formatDateTime"]
  key_links:
    - from: "backend/records/models.py"
      to: "backend/records/serializers.py"
      via: "model fields referenced in Meta.fields"
      pattern: "model = MailRecord"
    - from: "backend/records/models.py"
      to: "backend/records/admin.py"
      via: "fieldsets reference model fields"
      pattern: "fieldsets"
---

<objective>
Remove all deprecated model fields and dead frontend code from the codebase.

Purpose: Eliminate technical debt from three deprecated fields (action_required_other, remarks, user_remarks) that were superseded by newer patterns (free-text action_required, initial_instructions, AssignmentRemark timeline). Also remove unused date-fns imports and dead utility function from frontend.

Output: Clean models, serializers, admin, views, and frontend helpers. One Django migration removing the three fields.
</objective>

<execution_context>
@C:/Users/vaish/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vaish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/records/models.py
@backend/records/serializers.py
@backend/records/admin.py
@backend/records/views.py
@frontend/src/utils/dateHelpers.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove deprecated fields from models, serializers, and admin</name>
  <files>
    backend/records/models.py
    backend/records/serializers.py
    backend/records/admin.py
  </files>
  <action>
In backend/records/models.py:
1. Remove the `action_required_other` field from MailRecord (line 76: `action_required_other = models.CharField(max_length=100, blank=True, null=True)`).
2. Remove the `remarks` field from MailRecord (line 143: `remarks = models.TextField(blank=True, null=True, help_text="DEPRECATED: ...")`).
3. Remove the `user_remarks` field from MailAssignment (line 398: `user_remarks = models.TextField(blank=True, null=True)`).
4. In MailRecord.get_attachment_metadata() (around line 332-337), replace the inline size formatting logic with a call to `RecordAttachment._human_readable_size(size)`. This deduplicates the size formatting. The method should become:
   ```python
   def get_attachment_metadata(self):
       attachment = self.current_attachment
       if not attachment:
           return {
               'has_attachment': False,
               'attachment_id': None,
               'original_filename': None,
               'file_size': None,
               'file_size_human': None,
               'uploaded_at': None,
               'uploaded_by': None,
           }
       return {
           'has_attachment': True,
           'attachment_id': str(attachment.id),
           'original_filename': attachment.original_filename,
           'file_size': attachment.file_size,
           'file_size_human': RecordAttachment._human_readable_size(attachment.file_size),
           'uploaded_at': attachment.uploaded_at.isoformat() if attachment.uploaded_at else None,
           'uploaded_by': attachment.uploaded_by.username if attachment.uploaded_by else None,
       }
   ```
5. In MailRecord's `update_consolidated_remarks` method (line ~350-367), the query currently references `user_remarks` — update it to only pull from AssignmentRemark timeline instead. Replace:
   ```python
   assignments = self.parallel_assignments.filter(
       status__in=['Active', 'Completed']
   ).exclude(user_remarks__isnull=True).exclude(user_remarks='')
   ```
   With:
   ```python
   assignments = self.parallel_assignments.filter(
       status__in=['Active', 'Completed']
   ).prefetch_related('remarks_timeline')
   ```
   And update the loop to get the latest remark from timeline:
   ```python
   remarks_parts = []
   for a in assignments.order_by('created_at'):
       latest_remark = a.remarks_timeline.order_by('-created_at').first()
       if not latest_remark:
           continue
       status_label = "[DONE]" if a.status == 'Completed' else "[IN PROGRESS]"
       remarks_parts.append(
           f"{status_label} {a.assigned_to.full_name}: {latest_remark.content}"
       )
   ```

In backend/records/serializers.py:
1. Remove `action_required_other` from MailRecordCreateSerializer.Meta.fields (line 249).
2. Remove `'remarks'` from MailRecordUpdateSerializer.Meta.fields (line 369). Since remarks field is gone, this serializer becomes empty — replace fields with an empty list `[]` or remove the serializer if it is only used for remarks updates (check views.py update method).
3. Remove `'user_remarks'` from MailAssignmentSerializer.Meta.fields (line 412).
4. Remove `'user_remarks'` from MailAssignmentFullSerializer.Meta.fields (line 520).
5. In MailAssignmentSerializer.get_has_responded, remove `or bool(obj.user_remarks)` — rely solely on `obj.remarks_timeline.exists()` and reassignment check.
6. In MailAssignmentFullSerializer.get_has_responded, same removal of `or bool(obj.user_remarks)`.

In backend/records/admin.py:
1. Remove `'action_required_other'` from the 'Mail Information' fieldset (line 24).
2. Remove `'remarks'` from the 'Additional Info' fieldset (line 37).
  </action>
  <verify>
Run `python backend/manage.py check --deploy 2>&1 | head -20` to confirm no model errors. Also run `python -c "import django; django.setup(); from records.models import MailRecord; print([f.name for f in MailRecord._meta.get_fields()])"` with DJANGO_SETTINGS_MODULE set to confirm the fields are removed from model definition (they will still be in DB until migration).
  </verify>
  <done>
MailRecord model code has no action_required_other or remarks field definition. MailAssignment model code has no user_remarks field definition. Serializers and admin do not reference any of the three removed fields. _human_readable_size duplication is eliminated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update views.py references to removed fields and generate migration</name>
  <files>
    backend/records/views.py
  </files>
  <action>
In backend/records/views.py:
1. In the `close` method (around line 583), remove the line `mail_record.remarks = remarks` — the remarks field no longer exists. The close remarks are already stored in the audit trail and current_action_remarks.
2. In the `update` method (around line 398), remove `old_remarks = instance.remarks` and update the audit trail old_value/new_value dicts to not reference `remarks`. Since MailRecordUpdateSerializer now has no fields, the update method may need rethinking. Check if there are any remaining mutable fields. If not, leave the serializer with empty fields list — the update endpoint effectively becomes a no-op for direct field updates (action status updates go through update_current_action endpoint instead).
3. In the `update_assignment` method (around line 829), remove `assignment.user_remarks = user_remarks` and `assignment.save()`. Instead, create an AssignmentRemark entry (the timeline pattern). Replace:
   ```python
   assignment.user_remarks = user_remarks
   assignment.save()
   ```
   With:
   ```python
   AssignmentRemark.objects.create(
       assignment=assignment,
       content=user_remarks,
       created_by=request.user
   )
   ```
4. In the `add_assignment_remark` method (around line 931), remove the backward-compatibility lines:
   ```python
   # Also update user_remarks for backward compatibility
   assignment.user_remarks = content
   assignment.save()
   ```
5. In the `complete_assignment` method (around line 869), update the remarks check from `has_remarks = assignment.remarks_timeline.exists() or assignment.user_remarks` to just `has_remarks = assignment.remarks_timeline.exists()`.
6. In the MailAssignmentViewSet `update_remarks` method (around line 1228), remove `assignment.user_remarks = serializer.validated_data['remarks']` and `assignment.save()`. Instead create an AssignmentRemark. Update to:
   ```python
   AssignmentRemark.objects.create(
       assignment=assignment,
       content=serializer.validated_data['remarks'],
       created_by=request.user
   )
   ```
7. In the MailAssignmentViewSet `complete` method (around line 1265), remove `assignment.user_remarks = serializer.validated_data['remarks']`. Instead create an AssignmentRemark before marking complete:
   ```python
   AssignmentRemark.objects.create(
       assignment=assignment,
       content=serializer.validated_data['remarks'],
       created_by=request.user
   )
   ```

After all code changes, generate the migration:
```bash
cd backend && python manage.py makemigrations records --name remove_deprecated_fields
```

Then apply it:
```bash
cd backend && python manage.py migrate
```
  </action>
  <verify>
Run `python backend/manage.py makemigrations --check` to confirm no pending migrations. Run `python backend/manage.py migrate --run-syncdb` to confirm DB is clean. Grep for `user_remarks`, `action_required_other`, and the pattern `instance.remarks` or `mail_record.remarks` in views.py to confirm zero hits (excluding string literals in audit remarks text).
  </verify>
  <done>
views.py has no references to the three removed fields. Migration file exists and has been applied. Database schema no longer has the deprecated columns.
  </done>
</task>

<task type="auto">
  <name>Task 3: Remove dead frontend code from dateHelpers.js</name>
  <files>
    frontend/src/utils/dateHelpers.js
  </files>
  <action>
In frontend/src/utils/dateHelpers.js:
1. Remove `formatDistanceToNow` from the date-fns import on line 1. The import should become:
   ```javascript
   import { formatDistance, format, isPast } from 'date-fns';
   ```
2. Remove the entire `getRelativeTime` function (lines 50-58, including the JSDoc comment above it).
3. Verify no other file in frontend/src/ imports `getRelativeTime` (already confirmed — no imports exist).
  </action>
  <verify>
Run `cd frontend && npx eslint src/utils/dateHelpers.js --no-eslintrc --rule '{"no-unused-vars": "error", "import/no-unresolved": "off"}' 2>&1 || true`. Also grep the entire frontend/src directory for `getRelativeTime` and `formatDistanceToNow` to confirm zero hits.
  </verify>
  <done>
dateHelpers.js has no formatDistanceToNow import and no getRelativeTime function. No file in frontend/src/ references either symbol.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && python manage.py check` passes with no errors
2. `cd backend && python manage.py makemigrations --check` reports no pending migrations
3. `grep -rn "action_required_other" backend/records/models.py backend/records/serializers.py backend/records/admin.py` returns zero results
4. `grep -rn "user_remarks" backend/records/models.py backend/records/serializers.py backend/records/views.py` returns zero results (excluding string literals in audit remarks)
5. `grep -rn "formatDistanceToNow\|getRelativeTime" frontend/src/` returns zero results
6. `grep -n "_human_readable_size" backend/records/models.py` shows exactly one definition (in RecordAttachment) and one call (in MailRecord.get_attachment_metadata)
</verification>

<success_criteria>
- Three deprecated fields removed from model definitions
- Migration generated and applied successfully
- All serializer, admin, and view references updated
- Frontend dead code removed
- _human_readable_size exists in exactly one place (RecordAttachment static method)
- No regressions: Django check passes, no import errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-cleanup-refactoring/06-01-SUMMARY.md`
</output>
