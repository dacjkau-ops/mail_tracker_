---
phase: 04-password-change
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/users/views.py
  - backend/config/urls.py
autonomous: true
requirements:
  - PASSWD-03
  - PASSWD-04
  - PASSWD-05

must_haves:
  truths:
    - "POST /api/auth/change-password/ returns 200 and a success message when given valid username, correct current password, and a new password of 8+ characters"
    - "The endpoint returns 400 with a specific error message when the current password is wrong"
    - "The endpoint returns 400 with a specific error message when new_password and confirm_password do not match"
    - "The endpoint returns 400 with a specific error message when new_password is fewer than 8 characters"
    - "The endpoint is accessible without a JWT token (AllowAny permission)"
  artifacts:
    - path: "backend/users/views.py"
      provides: "ChangePasswordView class implementing the endpoint logic"
      contains: "ChangePasswordView"
    - path: "backend/config/urls.py"
      provides: "URL route wiring change-password endpoint"
      contains: "change-password"
  key_links:
    - from: "backend/config/urls.py"
      to: "backend/users/views.py"
      via: "path('api/auth/change-password/', ChangePasswordView.as_view())"
      pattern: "change-password.*ChangePasswordView"
    - from: "backend/users/views.py"
      to: "django.contrib.auth"
      via: "authenticate() then user.set_password()"
      pattern: "authenticate|set_password"
---

<objective>
Add a change-password API endpoint that allows any user to change their password by supplying their username and current password — no JWT token required.

Purpose: Users who are logged out (or whose session has expired) must be able to self-serve a password change without administrator involvement.
Output: `POST /api/auth/change-password/` endpoint returning `{"message": "Password changed successfully."}` on success and specific `{"error": "..."}` messages on failure.
</objective>

<execution_context>
@C:/Users/vaish/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/vaish/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/users/views.py
@backend/config/urls.py
@backend/users/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ChangePasswordView to users/views.py</name>
  <files>backend/users/views.py</files>
  <action>
Add a new APIView class `ChangePasswordView` at the bottom of `backend/users/views.py`.

Imports to add at the top of the file (alongside existing imports):
```python
from rest_framework.views import APIView
from rest_framework.permissions import AllowAny
from django.contrib.auth import authenticate
```

The view class:
```python
class ChangePasswordView(APIView):
    """Allow any user to change their password using username + current password."""
    permission_classes = [AllowAny]

    def post(self, request):
        username = request.data.get('username', '').strip()
        current_password = request.data.get('current_password', '')
        new_password = request.data.get('new_password', '')
        confirm_password = request.data.get('confirm_password', '')

        if not all([username, current_password, new_password, confirm_password]):
            return Response(
                {'error': 'All fields are required.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        if new_password != confirm_password:
            return Response(
                {'error': 'New passwords do not match.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        if len(new_password) < 8:
            return Response(
                {'error': 'New password must be at least 8 characters.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        user = authenticate(request, username=username, password=current_password)
        if user is None:
            return Response(
                {'error': 'Current password is incorrect.'},
                status=status.HTTP_400_BAD_REQUEST
            )

        user.set_password(new_password)
        user.save()
        logger.info(f"Password changed successfully for user: {username}")
        return Response(
            {'message': 'Password changed successfully.'},
            status=status.HTTP_200_OK
        )
```

Note: `Response`, `status`, and `logger` are already imported/defined in the file. Only add the three new imports (`APIView`, `AllowAny`, `authenticate`) that are not already present.
  </action>
  <verify>
From the backend directory, run:
```bash
python manage.py check
```
Expect: "System check identified no issues."
  </verify>
  <done>ChangePasswordView class exists in backend/users/views.py with AllowAny permission, validates all four required fields, returns specific error messages for each failure mode, and calls user.set_password() on success.</done>
</task>

<task type="auto">
  <name>Task 2: Wire the change-password URL in config/urls.py</name>
  <files>backend/config/urls.py</files>
  <action>
In `backend/config/urls.py`:

1. Add `ChangePasswordView` to the import from `users.views`:
   Change:
   ```python
   from users.views import UserViewSet, CustomTokenObtainPairView
   ```
   To:
   ```python
   from users.views import UserViewSet, CustomTokenObtainPairView, ChangePasswordView
   ```

2. Add the URL pattern in the `urlpatterns` list, directly after the existing `api/auth/refresh/` entry:
   ```python
   path('api/auth/change-password/', ChangePasswordView.as_view(), name='change_password'),
   ```

The endpoint must be listed BEFORE `path('api/', include(router.urls))` so it does not get caught by the router.
  </action>
  <verify>
From the backend directory, run:
```bash
python manage.py show_urls 2>/dev/null | grep change-password
```
If `django-extensions` is not installed, instead run:
```bash
python manage.py check && python -c "
import django, os
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()
from django.urls import reverse
print(reverse('change_password'))
"
```
Expect: `/api/auth/change-password/`

Then start the dev server and test with curl:
```bash
curl -s -X POST http://localhost:8000/api/auth/change-password/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","current_password":"wrongpass","new_password":"newpass123","confirm_password":"newpass123"}' | python -m json.tool
```
Expect: `{"error": "Current password is incorrect."}`
  </verify>
  <done>GET to /api/auth/change-password/ returns 405 (Method Not Allowed). POST with wrong current_password returns 400 with {"error": "Current password is incorrect."}. No JWT header is needed for the request to reach the view.</done>
</task>

</tasks>

<verification>
End-to-end verification for plan 04-01:

1. Start the backend: `python manage.py runserver 0.0.0.0:8000`
2. Test missing fields:
   ```bash
   curl -s -X POST http://localhost:8000/api/auth/change-password/ \
     -H "Content-Type: application/json" \
     -d '{}' | python -m json.tool
   ```
   Expect: `{"error": "All fields are required."}`

3. Test password mismatch:
   ```bash
   curl -s -X POST http://localhost:8000/api/auth/change-password/ \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","current_password":"correct","new_password":"abc12345","confirm_password":"abc12346"}' | python -m json.tool
   ```
   Expect: `{"error": "New passwords do not match."}`

4. Test too short:
   ```bash
   curl -s -X POST http://localhost:8000/api/auth/change-password/ \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","current_password":"correct","new_password":"abc","confirm_password":"abc"}' | python -m json.tool
   ```
   Expect: `{"error": "New password must be at least 8 characters."}`

5. Test wrong current password:
   ```bash
   curl -s -X POST http://localhost:8000/api/auth/change-password/ \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","current_password":"wrongpass","new_password":"newpass123","confirm_password":"newpass123"}' | python -m json.tool
   ```
   Expect: `{"error": "Current password is incorrect."}`

6. Test success (use real admin credentials):
   ```bash
   curl -s -X POST http://localhost:8000/api/auth/change-password/ \
     -H "Content-Type: application/json" \
     -d '{"username":"admin","current_password":"REAL_PASSWORD","new_password":"NewPass123","confirm_password":"NewPass123"}' | python -m json.tool
   ```
   Expect: `{"message": "Password changed successfully."}`
   Then verify old password no longer works for login.
</verification>

<success_criteria>
- POST /api/auth/change-password/ is reachable without a JWT token
- Returns 200 + {"message": "Password changed successfully."} on valid input
- Returns 400 + {"error": "Current password is incorrect."} for wrong current password
- Returns 400 + {"error": "New passwords do not match."} for confirm mismatch
- Returns 400 + {"error": "New password must be at least 8 characters."} for short password
- Returns 400 + {"error": "All fields are required."} for missing fields
- django.contrib.auth.authenticate() is used (not raw DB lookup) — respects Django's auth pipeline
- user.set_password() + user.save() called (password stored as hash, not plain text)
</success_criteria>

<output>
After completion, create `.planning/phases/04-password-change/04-01-SUMMARY.md` documenting:
- Files modified and key changes
- The exact request/response contract for the endpoint
- Any decisions made during implementation
</output>
